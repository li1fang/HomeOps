---
- name: Ensure GPU preparation artifact directory exists
  hosts: localhost
  gather_facts: false
  vars:
    gpu_prep_artifacts_dir: "{{ output_dir | default('artifacts/itest') }}"
  tasks:
    - name: Ensure GPU preparation artifact directory
      ansible.builtin.file:
        path: "{{ gpu_prep_artifacts_dir }}"
        state: directory
        mode: "0755"

- name: Prepare GPU nodes for Kubernetes and CUDA baseline
  hosts: gpu_nodes
  become: true
  gather_facts: true
  vars:
    nvidia_prereq_packages_default:
      - build-essential
      - dkms
      - gcc
      - make
      - pciutils
      - curl
      - software-properties-common
      - ca-certificates
    kernel_release: "{{ ansible_kernel }}"
    kernel_release_base: >-
      {{ kernel_release | regex_replace('-(generic|lowlatency)$', '') }}
    kernel_header_candidates: >-
      {{ [
          'linux-headers-' ~ kernel_release,
          'linux-headers-' ~ kernel_release_base,
          'linux-headers-' ~ kernel_release_base ~ '-generic'
        ] | unique }}
    user_defined_kernel_headers: >-
      {{ nvidia_kernel_headers_package
         if nvidia_kernel_headers_package is defined else [] }}
    user_defined_kernel_headers_list: >-
      {{ user_defined_kernel_headers
         if user_defined_kernel_headers is sequence and not (user_defined_kernel_headers is string)
         else ([user_defined_kernel_headers] if user_defined_kernel_headers else []) }}
    kernel_header_packages: >-
      {{ (kernel_header_candidates + user_defined_kernel_headers_list) | unique }}
    gpu_prereq_packages: >-
      {{ (
          (nvidia_prereq_packages | default(nvidia_prereq_packages_default)) +
          kernel_header_packages
        ) | unique }}
    nouveau_blacklist_path: "{{ nvidia_blacklist_file | default('/etc/modprobe.d/blacklist-nouveau.conf') }}"
  pre_tasks:
    - name: Assert supported operating system family
      ansible.builtin.assert:
        that:
          - ansible_os_family | lower == 'debian'
        fail_msg: >-
          GPU preparation currently supports Debian/Ubuntu families only; detected {{ ansible_os_family }}.
    - name: Unmask packagekit service to allow apt operations
      ansible.builtin.systemd:
        name: packagekit.service
        masked: false
        enabled: false
        state: stopped
      when: ansible_service_mgr == 'systemd'

    - name: Ensure dpkg is in a consistent state before installing packages
      ansible.builtin.command:
        cmd: dpkg --configure -a
      register: dpkg_preconfigure
      changed_when: false
      failed_when: dpkg_preconfigure.rc not in [0]
  tasks:
    - name: Update apt cache for GPU prerequisites
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    - name: Install GPU prerequisite packages
      ansible.builtin.apt:
        name: "{{ gpu_prereq_packages }}"
        state: present
        install_recommends: false
        force_apt_get: true

    - name: Gather kernel header linker script status (generic)
      ansible.builtin.stat:
        path: "/usr/src/linux-headers-{{ kernel_release }}/scripts/module.lds"
      register: kernel_module_lds_generic

    - name: Gather kernel header linker script status (base release)
      ansible.builtin.stat:
        path: "/usr/src/linux-headers-{{ kernel_release_base }}/scripts/module.lds"
      register: kernel_module_lds_base

    - name: Purge kernel headers when linker script missing
      ansible.builtin.apt:
        name: "{{ kernel_header_packages }}"
        state: absent
        purge: true
        force_apt_get: true
      register: purge_kernel_headers
      when: not kernel_module_lds_generic.stat.exists and not kernel_module_lds_base.stat.exists

    - name: Reinstall kernel headers after purge
      ansible.builtin.apt:
        name: "{{ kernel_header_packages }}"
        state: present
        install_recommends: false
        force_apt_get: true
      register: reinstall_kernel_headers
      when: purge_kernel_headers is defined and purge_kernel_headers.changed

    - name: Refresh generic kernel header linker script status
      ansible.builtin.stat:
        path: "/usr/src/linux-headers-{{ kernel_release }}/scripts/module.lds"
      register: kernel_module_lds_generic
      when: (purge_kernel_headers is defined and purge_kernel_headers.changed) or
            (reinstall_kernel_headers is defined and reinstall_kernel_headers.changed)

    - name: Refresh base kernel header linker script status
      ansible.builtin.stat:
        path: "/usr/src/linux-headers-{{ kernel_release_base }}/scripts/module.lds"
      register: kernel_module_lds_base
      when: (purge_kernel_headers is defined and purge_kernel_headers.changed) or
            (reinstall_kernel_headers is defined and reinstall_kernel_headers.changed)

    - name: Assert kernel headers provide module linker script
      ansible.builtin.assert:
        that:
          - kernel_module_lds_generic.stat.exists or kernel_module_lds_base.stat.exists
        fail_msg: >-
          Required kernel header linker script module.lds was not found after reinstalling
          linux-headers for {{ kernel_release }}.

    - name: Blacklist nouveau kernel driver
      ansible.builtin.copy:
        dest: "{{ nouveau_blacklist_path }}"
        content: |
          # Managed by HomeOps GPU preparation
          blacklist nouveau
          options nouveau modeset=0
        owner: root
        group: root
        mode: "0644"
      notify:
        - Rebuild initramfs after nouveau blacklist
        - Remove nouveau kernel module if loaded

    - name: Install NVIDIA driver package
      ansible.builtin.apt:
        name: "{{ nvidia_driver_package | default('nvidia-driver-535') }}"
        state: present
        update_cache: false
        force_apt_get: true

    - name: Configure remaining packages after driver installation
      ansible.builtin.command:
        cmd: dpkg --configure -a
      register: dpkg_postconfigure
      changed_when: false
      failed_when: dpkg_postconfigure.rc not in [0]

    - name: Ensure nvidia-persistenced service is enabled
      ansible.builtin.systemd:
        name: nvidia-persistenced
        state: started
        enabled: true
      register: nvidia_persistenced_state
      failed_when: >-
        nvidia_persistenced_state is failed and
        (
          'not found' not in (nvidia_persistenced_state.msg | default('') | lower)
          and 'could not be found' not in (nvidia_persistenced_state.msg | default('') | lower)
        )

    - name: Gather lspci output for NVIDIA adapters
      ansible.builtin.command:
        cmd: lspci -nn
      register: lspci_output
      changed_when: false

    - name: Assert NVIDIA GPU detected
      ansible.builtin.assert:
        that:
          - "'NVIDIA' in lspci_output.stdout"
        fail_msg: >-
          No NVIDIA GPU detected on {{ inventory_hostname }}. lspci output stored in task result for diagnostics.

    - name: Run nvidia-smi to validate driver readiness
      ansible.builtin.command:
        cmd: nvidia-smi
      register: nvidia_smi_check
      changed_when: false
      retries: 3
      delay: 10
      until: nvidia_smi_check.rc == 0

  handlers:
    - name: Rebuild initramfs after nouveau blacklist
      ansible.builtin.command:
        cmd: update-initramfs -u
      changed_when: true

    - name: Remove nouveau kernel module if loaded
      ansible.builtin.command:
        cmd: modprobe -r nouveau
      register: remove_nouveau
      failed_when: remove_nouveau.rc not in [0, 1]
      changed_when: remove_nouveau.rc == 0
