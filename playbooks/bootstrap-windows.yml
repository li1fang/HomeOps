- name: Bootstrap Windows nodes (OpenSSH + to-linux.ps1)
  hosts: windows
  gather_facts: false

  tasks:
    - name: Ensure C:\ops exists
      ansible.windows.win_file:
        path: C:\ops
        state: directory

    - name: Deploy to-linux.ps1
      ansible.windows.win_template:
        src: ../templates/to-linux.ps1.j2
        dest: "C:\\ops\\to-linux.ps1"
        newline_sequence: "\r\n"

    - name: Enable and start OpenSSH Server
      ansible.windows.win_shell: |
        powershell -NoProfile -Command "
          if (-not (Get-Service sshd -ErrorAction SilentlyContinue)) {
            Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0 | Out-Null
          }
          Set-Service -Name sshd -StartupType Automatic
          if ((Get-Service sshd).Status -ne 'Running') { Start-Service sshd }
        "

    - name: Ensure firewall rule for TCP 22 exists
      ansible.windows.win_shell: |
        powershell -NoProfile -Command "
          if (-not (Get-NetFirewallRule -DisplayName 'OpenSSH Server (TCP 22)' -ErrorAction SilentlyContinue)) {
            New-NetFirewallRule -DisplayName 'OpenSSH Server (TCP 22)' -Direction Inbound -Protocol TCP -LocalPort 22 -Action Allow -Profile Any | Out-Null
          }
        "
