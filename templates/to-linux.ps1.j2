# templates/to-linux.ps1.j2
# 仅查找“UbuntuDirect”，避免 shim 路径，确保一次性引导稳定
# 要求：管理员权限；Fast Startup 已关闭（repair-boot-final.yml 已处理）

$fw = bcdedit /enum firmware
$hit = ($fw | Select-String -Pattern '^\s*description\s+UbuntuDirect\s*$' -SimpleMatch | Select-Object -First 1)
if (-not $hit) { throw "Cannot find the 'UbuntuDirect' firmware entry. Please run the repair playbook's Linux tasks first." }

# 回溯寻找 GUID 行
$line = $hit.LineNumber
$guid = $null
for ($i=$line-3; $i -ge 0; $i--) {
  if ($fw[$i] -match '\{[0-9a-fA-F\-]+\}') { $guid = $matches[0]; break }
}
if (-not $guid) { throw "Could not parse the GUID for UbuntuDirect." }

Write-Host "Boot once to: $guid"
bcdedit /bootsequence $guid
shutdown /r /t 0
